<?php

use \Drupal\Core\Form\FormStateInterface;

/**
 * @file
 * Module to create result pages.
 */

/**
 * Implements hook_theme().
 */
function dhsc_result_viewer_theme()
{
  return [
    'dhsc_results_list_assured_solutions' => [
      'variables' => [
        'summary' => NULL,
        'search_criteria' => NULL,
        'count' => NULL,
        'non_matching_count' => NULL,
        'total_count' => NULL,
        'submission_url' => NULL,
        'no_matches' => NULL,
        'result' => NULL,
        'no_result' => NULL,
        'email_form' => NULL,
      ],
    ],
    'dhsc_results_list_self_assessment' => [
      'variables' => [
        'title' => NULL,
        'summary' => NULL,
        'result_variant' => NULL,
        'submission_url' => NULL,
        'result' => NULL,
        'no_result' => NULL,
      ],
    ],
    'search_criteria' => [
      'variables' => [
        'section' => NULL,
        'answers' => NULL,
      ],
    ],
    'partial_match' => [
      'variables' => [
        'title' => NULL,
        'url' => NULL,
        'answers' => [
          'section' => NULL,
          'answer' => NULL,
        ],
      ],
    ],
    'no_match' => [
      'variables' => [
        'title' => NULL,
        'url' => NULL,
        'section' => NULL,
        'answers' => [
          'answer' => NULL
        ],
      ],
    ],
    'result_item' => [
      'variables' => [
        'content' => NULL,
      ],
    ],
    'result_item_self_assessment' => [
      'variables' => [
        'title' => NULL,
        'answer' => NULL,
        'content' => NULL,
      ],
    ],
    'mimemail_message__dhsc_result_viewer' => [
      'render element' => 'elements',
      'base hook' => 'mimemail_message',
    ],
  ];
}

/**
 * Implements hook_form_alter().
 *
 * @param [type] $form
 * @param FormStateInterface $form_state
 * @param [type] $form_id
 */
function dhsc_result_viewer_form_alter(&$form, FormStateInterface $form_state, $form_id)
{
  // Re-write submit label when re-submitting answers.
  $form_ids = [
    'webform_submission_assured_solutions_tool_edit_form',
    'webform_submission_self_assessment_tool_edit_form',
  ];

  if (
    in_array($form_id, $form_ids) &&
    (string) $form['actions']['submit']['#value'] === 'Save'
  ) {
    $form['actions']['submit']['#value'] = t('Continue');
  }
}

/**
 * Implements hook_mail().
 */
function dhsc_result_viewer_mail($key, &$message, $params)
{
  $message['from'] = $params['headers']['From'] ?? NULL;
  // Strip newline characters from email subjects.
  $message['subject'] = isset($params['subject']) ? str_replace(["\r\n", "\r", "\n"], ' ', $params['subject']) : NULL;
  $message['body'] = $params['body'];
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * @param $variables
 */
function dhsc_result_viewer_preprocess_status_messages(&$variables)
{
  if (isset($variables['message_list']['status'])) {
    $status_messages = $variables['message_list']['status'];
    foreach ($status_messages as $key => $message) {
      // Remove status message if updating submission.
      if (strpos((string) $message, 'Submission updated') !== FALSE) {
        unset($variables['message_list']['status'][$key]);
      }
    }
  }
}
